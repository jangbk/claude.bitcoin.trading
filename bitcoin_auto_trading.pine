//@version=6
strategy("Optimized MA Crossover (50/55)", 
         shorttitle="MA 50/55", 
         overlay=true, 
         initial_capital=10000, 
         default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100,  // 100% of equity per trade
         commission_type=strategy.commission.percent,
         commission_value=0.1)

// ============================================================================
// RESEARCH-BACKED PARAMETERS
// ============================================================================
// Based on Bloomberg research showing 50/55 MA outperformed 50/200 MA
// 5-year return: 7,830% vs 937% (8.3x better)

fastMA = input.int(50, "Fast MA Period", minval=1, group="Moving Averages")
slowMA = input.int(55, "Slow MA Period", minval=1, group="Moving Averages")
useMarketFilter = input.bool(true, "Use Market Regime Filter", group="Market Filter")
marketFilterMA = input.int(200, "Market Filter MA Period", minval=1, group="Market Filter")
useATRStops = input.bool(true, "Use ATR-based Stops", group="Risk Management")
atrLength = input.int(14, "ATR Length", minval=1, group="Risk Management")
atrMultiplier = input.float(2.0, "ATR Stop Multiplier", minval=0.1, step=0.1, group="Risk Management")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// Simple Moving Averages
ma50 = ta.sma(close, fastMA)
ma55 = ta.sma(close, slowMA)
ma200 = ta.sma(close, marketFilterMA)

// Market Regime Filter
// Only trade when price is above 200 MA (strong uptrend)
bullMarket = useMarketFilter ? close > ma200 : true

// ATR for stop loss
atr = ta.atr(atrLength)

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// Golden Cross: Fast MA crosses above Slow MA
goldenCross = ta.crossover(ma50, ma55)

// Death Cross: Fast MA crosses below Slow MA
deathCross = ta.crossunder(ma50, ma55)

// ============================================================================
// ENTRY CONDITIONS
// ============================================================================

// Only enter trades during bull market (price above 200 MA)
longCondition = goldenCross and bullMarket
shortCondition = deathCross and bullMarket  // Can still short, but only in confirmed bull markets

// ============================================================================
// RISK MANAGEMENT
// ============================================================================

// ATR-based stop loss
var float longStopLevel = na
var float shortStopLevel = na

if longCondition
    longStopLevel := close - (atr * atrMultiplier)
    
if shortCondition
    shortStopLevel := close + (atr * atrMultiplier)

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Enter Long on Golden Cross
if longCondition
    strategy.entry("Long", strategy.long)
    if useATRStops
        strategy.exit("Long Exit", "Long", stop=longStopLevel)

// Close Long on Death Cross
if shortCondition and strategy.position_size > 0
    strategy.close("Long")

// Optional: Enter Short on Death Cross (can be disabled)
// if shortCondition
//     strategy.entry("Short", strategy.short)
//     if useATRStops
//         strategy.exit("Short Exit", "Short", stop=shortStopLevel)

// Close Short on Golden Cross
if longCondition and strategy.position_size < 0
    strategy.close("Short")

// ============================================================================
// VISUAL INDICATORS
// ============================================================================

// Plot Moving Averages
plot(ma50, "50 MA", color=color.new(color.blue, 0), linewidth=2)
plot(ma55, "55 MA", color=color.new(color.orange, 0), linewidth=2)
plot(ma200, "200 MA (Market Filter)", color=color.new(color.red, 0), linewidth=3)

// Plot Buy/Sell Signals
plotshape(goldenCross, "Golden Cross", shape.triangleup, location.belowbar, 
          color.new(color.green, 0), size=size.normal, text="BUY")
plotshape(deathCross, "Death Cross", shape.triangledown, location.abovebar, 
          color.new(color.red, 0), size=size.normal, text="SELL")

// Background color for trend and market regime
trendColor = not bullMarket ? color.new(color.gray, 97) : 
             ma50 > ma55 ? color.new(color.green, 95) : color.new(color.red, 95)
bgcolor(trendColor, title="Trend Background")

// ============================================================================
// INFORMATION DISPLAY
// ============================================================================

// Create table for strategy info
var table infoTable = table.new(position.top_right, 2, 5, border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Strategy", text_color=color.white, bgcolor=color.gray)
    table.cell(infoTable, 1, 0, "MA 50/55 + Filter", text_color=color.white, bgcolor=color.gray)
    
    table.cell(infoTable, 0, 1, "Fast MA", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(fastMA), text_color=color.white)
    
    table.cell(infoTable, 0, 2, "Slow MA", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(slowMA), text_color=color.white)
    
    table.cell(infoTable, 0, 3, "Market", text_color=color.white)
    table.cell(infoTable, 1, 3, bullMarket ? "BULL" : "BEAR/RANGE", 
              text_color=color.white, 
              bgcolor=bullMarket ? color.green : color.gray)
    
    table.cell(infoTable, 0, 4, "Trend", text_color=color.white)
    table.cell(infoTable, 1, 4, ma50 > ma55 ? "UP" : "DOWN", 
              text_color=color.white, 
              bgcolor=ma50 > ma55 ? color.green : color.red)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(goldenCross, "Golden Cross Alert", "BTC: Golden Cross (50 MA > 55 MA) - BUY SIGNAL!")
alertcondition(deathCross, "Death Cross Alert", "BTC: Death Cross (50 MA < 55 MA) - SELL SIGNAL!")
